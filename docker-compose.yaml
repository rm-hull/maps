name: maps

networks:
  default:
  homelab-net:
    external: true

volumes:
  config_volume:

services:
  config-generator:
    image: alpine
    env_file:
      - .env.local
    volumes:
      - ./mapproxy/config:/tmp
      - config_volume:/output
    command: >
      sh -c "
        apk add --no-cache gettext &&
        envsubst < /tmp/mapproxy.template.yaml > /output/mapproxy.yaml
      "

  mapproxy:
    container_name: mapproxy
    restart: unless-stopped
    image: ghcr.io/mapproxy/mapproxy/mapproxy:5.0.0-alpine-nginx
    depends_on:
      config-generator:
        condition: service_completed_successfully
    volumes:
      - config_volume:/mapproxy/config
      - ./mapproxy/cache_data:/mapproxy/cache_data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mapproxy.entrypoints=websecure"
      - "traefik.http.routers.mapproxy.rule=Host(`api.homelab.destructuring-bind.org`) && PathPrefix(`/mapproxy/wmts/wmts`)"
      - "traefik.http.services.mapproxy.loadbalancer.server.port=80"
      - "dockflare.enable=true"
      - "cloudflare.tunnel.enable=true"
      - "cloudflare.tunnel.hostname=api.destructuring-bind.org"
      - "cloudflare.tunnel.path=/mapproxy/wmts/wmts"
      - "cloudflare.tunnel.service=http://mapproxy:80"
    networks:
      - default
      - homelab-net